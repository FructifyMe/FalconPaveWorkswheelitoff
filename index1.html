<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon Pave Works Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.2/mapbox-gl-draw.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.2/mapbox-gl-draw.min.js"></script>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Custom Scrollbar for Sidebar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- CRITICAL FIXES --- */
        
        /* 1. Restore Button Styles (Tailwind Reset Fix) */
        .mapboxgl-ctrl-group > button {
            width: 29px;
            height: 29px;
            display: block;
            padding: 0;
            outline: none;
            border: 0;
            box-sizing: border-box;
            background-color: #ffffff !important; /* Force white background */
            cursor: pointer;
        }
        
        /* 2. Ensure Icons are visible */
        .mapbox-gl-draw_ctrl-draw-btn {
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 3. Fix Geocoder Z-Index */
        .mapboxgl-ctrl-geocoder { 
            min-width: 300px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }
        
        /* 4. Force Drawing Tools to be visible above map */
        .mapboxgl-ctrl-top-right { 
            z-index: 50 !important; 
            margin-top: 10px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="flex h-screen w-screen bg-gray-50 font-sans text-gray-900">

    <div class="w-96 bg-white shadow-xl z-20 flex flex-col border-r border-gray-200 h-full relative shrink-0">
        
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                Falcon Pave Works
            </h1>
            <p class="text-sm text-gray-500 mt-1">Internal Estimation Tool</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-8 scrollbar-hide">
            
            <section class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-600">
                <p class="font-semibold mb-2 text-gray-900">How to use:</p>
                <ul class="list-disc pl-4 space-y-1 text-xs">
                    <li><strong>Search:</strong> Use top-left bar to find address.</li>
                    <li><strong>Draw:</strong> Click the Polygon tool (top-right) to draw.</li>
                    <li><strong>Edit:</strong> Click a shape to select it.</li>
                    <li><strong>Islands:</strong> Select shape & click "Toggle Exclusion".</li>
                </ul>
            </section>

            <section>
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Job Specs</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Asphalt Thickness (inches)</label>
                        <input 
                            type="number" 
                            id="input-thickness"
                            value="2.0" 
                            step="0.5"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mix Density (lbs/ftÂ³)</label>
                        <input 
                            type="number" 
                            id="input-density"
                            value="145" 
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none"
                        >
                    </div>
                </div>
            </section>

            <section id="section-selection" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-100 transition-all">
                <h3 class="text-sm font-semibold text-blue-900 mb-3">Selection Actions</h3>
                <div class="flex gap-2">
                    <button 
                        id="btn-toggle-exclusion"
                        class="flex-1 py-2 px-3 bg-white border border-blue-200 text-blue-700 text-sm font-medium rounded hover:bg-blue-100 transition-colors shadow-sm"
                    >
                        Toggle Exclusion
                    </button>
                    <button 
                        id="btn-delete"
                        class="p-2 bg-white border border-red-200 text-red-600 rounded hover:bg-red-50 transition-colors shadow-sm"
                        title="Delete Selected"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                    </button>
                </div>
                <p class="text-xs text-blue-600 mt-2 flex items-start gap-1">
                    <svg class="mt-0.5 shrink-0" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Mark shapes as "Exclusion" (Red) to subtract them from the total area.
                </p>
            </section>

            <div id="section-empty" class="p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-center">
                <p class="text-sm text-gray-500">Select a shape on the map to modify it.</p>
            </div>

            <section class="bg-gray-900 text-white p-6 rounded-xl shadow-lg mt-auto">
                <div class="flex items-center gap-2 mb-6 border-b border-gray-700 pb-4">
                    <svg class="text-green-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></svg>
                    <h2 class="text-lg font-bold">Estimation</h2>
                </div>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Gross Area</span>
                        <span id="val-gross">0 sq ft</span>
                    </div>
                    <div class="flex justify-between text-sm text-red-400">
                        <span>Exclusions</span>
                        <span id="val-excluded">-0 sq ft</span>
                    </div>
                    <div class="flex justify-between font-medium pt-2 border-t border-gray-700">
                        <span>Net Area</span>
                        <span id="val-net" class="text-white">0 sq ft</span>
                    </div>
                </div>

                <div class="bg-green-500/20 border border-green-500/50 p-4 rounded-lg text-center">
                    <span class="block text-sm text-green-200 uppercase tracking-wider font-semibold mb-1">Required Material</span>
                    <span class="block text-4xl font-bold text-white tracking-tight">
                        <span id="val-tons">0.00</span>
                        <span class="text-xl font-normal text-green-200 ml-1">tons</span>
                    </span>
                </div>
            </section>

        </div>
    </div>

    <div class="flex-1 relative h-full">
        <div id="map"></div>
    </div>

    <script>
        // --- CONFIG ---
        // Hardcoded API Key from user
        const PROVIDED_KEY = 'pk.eyJ1IjoiZnJ1Y3RpZnltZSIsImEiOiJjbWk3cGtjOWYwM2psMm5vczJ4eDRxamN0In0.JMcTVNmkgG3Lotc_vNmSWA';
        
        let map;
        let draw;
        
        // --- APP INIT ---
        (function initApp() {
            mapboxgl.accessToken = PROVIDED_KEY;

            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-streets-v12',
                    center: [-98.5795, 39.8283], // US Center
                    zoom: 3
                });
            } catch (e) {
                alert("Error initializing map: " + e.message);
                return;
            }

            map.on('load', () => {
                // 1. Navigation
                map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

                // 2. Geocoder
                const geocoder = new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    mapboxgl: mapboxgl,
                    marker: false,
                    placeholder: 'Search for address...',
                    zoom: 19
                });
                map.addControl(geocoder, 'top-left');

                // 3. Draw Tools
                draw = new MapboxDraw({
                    displayControlsDefault: false,
                    controls: {
                        polygon: true,
                        trash: true
                    },
                    defaultMode: 'simple_select',
                    styles: getDrawStyles()
                });
                map.addControl(draw, 'top-right');

                // 4. Events
                setupMapEvents();
            });
        })();

        // --- STATE & DOM ---
        const state = { thickness: 2.0, density: 145, selectedIds: [] };
        
        const elGross = document.getElementById('val-gross');
        const elExcluded = document.getElementById('val-excluded');
        const elNet = document.getElementById('val-net');
        const elTons = document.getElementById('val-tons');
        const sectionSelection = document.getElementById('section-selection');
        const sectionEmpty = document.getElementById('section-empty');
        const btnToggleExclusion = document.getElementById('btn-toggle-exclusion');
        const btnDelete = document.getElementById('btn-delete');

        // --- EVENTS ---
        function setupMapEvents() {
            map.on('draw.create', updateStats);
            map.on('draw.delete', updateStats);
            map.on('draw.update', updateStats);
            map.on('draw.selectionchange', (e) => {
                state.selectedIds = e.features.map(f => f.id);
                updateUISelection();
            });
        }

        function updateStats() {
            const data = draw.getAll();
            let paveArea = 0;
            let excludeArea = 0;

            data.features.forEach(feature => {
                const areaSqMeters = turf.area(feature);
                const areaSqFt = areaSqMeters * 10.7639;
                if (feature.properties?.user_type === 'exclusion') {
                    excludeArea += areaSqFt;
                } else {
                    paveArea += areaSqFt;
                }
            });

            const netArea = Math.max(0, paveArea - excludeArea);
            const tons = (netArea * (state.thickness / 12) * state.density) / 2000;

            elGross.innerText = Math.round(paveArea).toLocaleString() + ' sq ft';
            elExcluded.innerText = '-' + Math.round(excludeArea).toLocaleString() + ' sq ft';
            elNet.innerText = Math.round(netArea).toLocaleString() + ' sq ft';
            elTons.innerText = tons.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateUISelection() {
            if (state.selectedIds.length > 0) {
                sectionSelection.classList.remove('hidden');
                sectionEmpty.classList.add('hidden');
                const firstFeature = draw.get(state.selectedIds[0]);
                if(firstFeature.properties?.user_type === 'exclusion') {
                    btnToggleExclusion.innerText = "Set to Pavement";
                    btnToggleExclusion.className = "flex-1 py-2 px-3 bg-red-50 border border-red-200 text-red-700 text-sm font-medium rounded hover:bg-red-100 transition-colors shadow-sm";
                } else {
                    btnToggleExclusion.innerText = "Set as Exclusion";
                    btnToggleExclusion.className = "flex-1 py-2 px-3 bg-white border border-blue-200 text-blue-700 text-sm font-medium rounded hover:bg-blue-100 transition-colors shadow-sm";
                }
            } else {
                sectionSelection.classList.add('hidden');
                sectionEmpty.classList.remove('hidden');
            }
        }

        // --- INPUT LISTENERS ---
        document.getElementById('input-thickness').addEventListener('input', (e) => {
            state.thickness = parseFloat(e.target.value) || 0;
            updateStats();
        });
        document.getElementById('input-density').addEventListener('input', (e) => {
            state.density = parseFloat(e.target.value) || 0;
            updateStats();
        });
        btnToggleExclusion.addEventListener('click', () => {
            state.selectedIds.forEach(id => {
                const f = draw.get(id);
                const newType = f.properties?.user_type === 'exclusion' ? 'pavement' : 'exclusion';
                draw.setFeatureProperty(id, 'user_type', newType);
            });
            draw.changeMode('simple_select', { featureIds: state.selectedIds });
            updateStats();
            updateUISelection();
        });
        btnDelete.addEventListener('click', () => {
            draw.trash();
            state.selectedIds = [];
            updateUISelection();
            updateStats();
        });

        // --- STYLES ---
        function getDrawStyles() {
            return [
                // ACTIVE (Drawing)
                {
                    'id': 'gl-draw-line-active',
                    'type': 'line',
                    'filter': ['all', ['==', '$type', 'LineString'], ['==', 'active', 'true']],
                    'layout': { 'line-cap': 'round', 'line-join': 'round' },
                    'paint': { 'line-color': '#fbb03b', 'line-dasharray': [0.2, 2], 'line-width': 2 }
                },
                {
                    'id': 'gl-draw-polygon-fill-active',
                    'type': 'fill',
                    'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],
                    'paint': { 'fill-color': '#fbb03b', 'fill-opacity': 0.2 }
                },
                {
                    'id': 'gl-draw-polygon-stroke-active',
                    'type': 'line',
                    'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],
                    'paint': { 'line-color': '#fbb03b', 'line-dasharray': [0.2, 2], 'line-width': 2 }
                },
                // VERTICES
                {
                    'id': 'gl-draw-polygon-and-line-vertex-stroke-inactive',
                    'type': 'circle',
                    'filter': ['all', ['==', 'meta', 'vertex'], ['==', '$type', 'Point'], ['!=', 'mode', 'static']],
                    'paint': { 'circle-radius': 5, 'circle-color': '#fff' }
                },
                {
                    'id': 'gl-draw-polygon-and-line-vertex-inactive',
                    'type': 'circle',
                    'filter': ['all', ['==', 'meta', 'vertex'], ['==', '$type', 'Point'], ['!=', 'mode', 'static']],
                    'paint': { 'circle-radius': 3, 'circle-color': '#fbb03b' }
                },
                // STATIC (Finished)
                // Standard Pavement (Black)
                {
                    'id': 'gl-draw-polygon-fill-static',
                    'type': 'fill',
                    'filter': ['all', ['==', 'active', 'false'], ['==', '$type', 'Polygon'], ['!=', 'user_type', 'exclusion']],
                    'paint': { 'fill-color': '#000000', 'fill-opacity': 0.4 }
                },
                {
                    'id': 'gl-draw-polygon-stroke-static',
                    'type': 'line',
                    'filter': ['all', ['==', 'active', 'false'], ['==', '$type', 'Polygon'], ['!=', 'user_type', 'exclusion']],
                    'paint': { 'line-color': '#000000', 'line-width': 2 }
                },
                // Exclusion (Red)
                {
                    'id': 'gl-draw-polygon-fill-exclusion',
                    'type': 'fill',
                    'filter': ['all', ['==', 'active', 'false'], ['==', '$type', 'Polygon'], ['==', 'user_type', 'exclusion']],
                    'paint': { 'fill-color': '#ef4444', 'fill-opacity': 0.4 }
                },
                {
                    'id': 'gl-draw-polygon-stroke-exclusion',
                    'type': 'line',
                    'filter': ['all', ['==', 'active', 'false'], ['==', '$type', 'Polygon'], ['==', 'user_type', 'exclusion']],
                    'paint': { 'line-color': '#ef4444', 'line-width': 2 }
                },
                // Midpoints
                {
                    'id': 'gl-draw-polygon-midpoint',
                    'type': 'circle',
                    'filter': ['all', ['==', '$type', 'Point'], ['==', 'meta', 'midpoint']],
                    'paint': { 'circle-radius': 3, 'circle-color': '#fbb03b' }
                }
            ];
        }
    </script>
</body>
</html>
